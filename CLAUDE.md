# Инструкции для всех репозиториев

> Slim-ядро: триггеры + правила. Детали протоколов → memory/protocol-*.md (подгружаются по триггеру).

---

## 1. Архитектура репозиториев

### Типы (3 типа)

| Тип | Подтип | Что содержит | Source-of-truth | Кто создаёт |
|-----|--------|-------------|-----------------|-------------|
| **Base** | Принципы | ZP, FPF, SPF — принципы и фреймворки корректности | Да | Платформа |
| **Base** | Форматы | FMT-* — протоколы структуры репо | Да (для формата) | Платформа |
| **Pack** | — | Паспорт предметной области (вторые принципы) | Да | Пользователь |
| **DS** | instrument | Код, боты, агенты, MCP | Нет | Пользователь |
| **DS** | governance | Планы, реестры, координация | Нет | Пользователь |
| **DS** | surface | Курсы, гайды, публикации | Нет | Пользователь |

> **Base = платформа выдаёт. Pack и DS = пользователь создаёт.**
> **Pack — единственный source-of-truth для доменного знания. DS меняется вслед за Pack.**

### Fallback Chain

DS (3-й) → Pack (2-й) → Base.Принципы (SPF → FPF → ZP)

### Иерархия принципов

```
Level 0: ZP (нулевые принципы)       ← принципы, нет фреймворка         ⎤
Level 1: FPF (первые принципы)       ← принципы + фреймворк (бандл)     ⎥ Base
Level 2: SPF (вторые, фреймворк)     ← фреймворк корректности           ⎦
Level 2: Pack (вторые, содержание)   ← доменные знания                    Pack
Level 3: DS (третьи принципы)        ← производные от Pack                DS
```

### MAPSTRATEGIC.md vs Strategy.md

| Файл | Где | Кто пишет |
|------|-----|-----------|
| `MAPSTRATEGIC.md` | В репо системы | Владелец системы — «куда двигается ЭТА система» |
| `Strategy.md` | `DS-strategy/docs/` | Стратег — общая стратегия, агрегат из MAPSTRATEGIC |

> Детали типов репо, именование, измерения: → `memory/repo-type-rules.md`

---

## 2. Стадии сессии — ОРЗ (Открытие → Работа → Закрытие)

> **Три стадии, три протокола.** Пропуск Открытия = незапланированная работа. Пропуск Закрытия = незафиксированный результат.

| Стадия | Протокол | Триггер |
|--------|----------|---------|
| **Открытие** | `Read memory/protocol-open.md` → выполнить | Любое задание (без исключений) |
| **Работа** | `Read memory/protocol-work.md` → правила ниже | После прохождения Открытия |
| **Закрытие** | `Read memory/protocol-close.md` → выполнить | «закрываю» / «всё» / «закрывай» |

### Блокирующие правила (всегда в контексте)

1. **WP Gate:** При ЛЮБОМ задании → протокол Открытия → выполнить ДО начала работы.
2. **Push:** Незапушенные коммиты → ОБЯЗАН спросить «Запушить?». Push ДО отчёта Закрытия.
3. **Pull-before-Commit (DS-strategy):** `git pull --rebase` → модификация → `commit` → `push`. Нарушение = конфликты.
4. **Без Obsidian (DS-strategy):** Просмотр через VS Code, НЕ Obsidian.
5. **Close:** При триггере Закрытия → протокол Закрытия → выполнить.

### Протокол Работы (summary, полный → `memory/protocol-work.md`)


**Capture-to-Pack** — на каждом рубеже (подзадача, паттерн, решение, оптимизация): есть ли знание для записи?

| Тип знания | Куда | Когда | Через KE? |
|------------|------|-------|-----------|
| Правило для всех репо (1-3 строки) | `{{WORKSPACE_DIR}}/CLAUDE.md` | Сразу | Нет |
| Правило для одного репо (1-3 строки) | `<repo>/CLAUDE.md` | Сразу | Нет |
| Доменное (архитектура, паттерны) | Соответствующий Pack | Close | Да (KE) |
| Различение, метод, FM, WP | Соответствующий Pack | Close | Да (KE) |
| Крупный урок | `memory/<topic>.md` | Close | Нет |

> Анонсировать: *«Capture: [что] → [куда]»*

### Pre-action Gates

| Момент | Проверка |
|--------|---------|
| Перед `git commit` в репо с CLAUDE.md | Прочитать CLAUDE.md репо → exit protocol |
| Перед предложением архитектурного решения | АрхГейт (§5) |
| Перед разработкой/интеграцией нового инструмента, агента или системы | **IntegrationGate:** СТОП. (1) тип (инструмент/агент/система), (2) **контур:** L2 Platform / L3 Template / L4 Personal, (3) роли, (4) продукты, (5) процессы. Нет ответов → НЕ начинать. Любое развитие (новый сервис, инструмент, MCP, интеграция) = сначала определи контур → опиши → потом реализуй. |

---

## 3. Описания методов (PROCESSES.md)

> FPF-точный термин: **описание метода** (U.MethodDescription). Житейские синонимы: «процесс», «сервис» — полисемичны (FPF L-PROC, L-SERV), но допустимы в нашем UL.

| Термин (UL) | Что | FPF |
|-------------|-----|-----|
| **Описание метода** | Спецификация «как делать» (рецепт/SOP) | U.MethodDescription |
| **Сервис** | Именованная точка входа (= entry point) | accessSpec : MethodDescription |
| **Сценарий** | Межсистемное описание метода (владелец меняется) | MethodDescription spanning BCs |

| Масштаб | Требование |
|---------|-----------|
| ≤15 мин | Не нужен |
| Внутри системы | `<repo>/PROCESSES.md` |
| Новая система | Сценарий + процессы + данные (ВДВ) |

> При добавлении/изменении сервиса: обновить ОБА места. При утреннем чеке: сверять по MAP.002.

---

## 4. Memory (Слой 3)

| Ситуация | Читай |
|----------|-------|
| Поиск файлов/репо | `memory/navigation.md` |
| Работа с Pack-репо | `memory/repo-type-rules.md` |
| Терминология | `memory/hard-distinctions.md` |
| FPF-паттерн | `memory/fpf-reference.md` |
| Создание документа | `memory/checklists.md` |
| Архитектурное решение / SOTA | `memory/sota-reference.md` |

Политика: ≤10 файлов, ≤100 строк каждый. Кросс-системное → memory/. Системное → repo/CLAUDE.md.
Backup на Close: `memory/ + CLAUDE.md → DS-strategy/exocortex/`

---

## 5. MCP — доступ к знаниям

> **2 MCP-сервера** подключены автоматически через `.claude/settings.local.json`. Claude Code получает прямой доступ к базе знаний платформы.

| MCP-сервер | Назначение | Инструменты |
|------------|-----------|-------------|
| **knowledge-mcp** | Поиск по Pack, guides, DS (~5400 документов) | `search`, `get_document`, `list_sources` |
| **ddt** | Цифровой двойник ученика (метамодель, цели, самооценка) | `describe_by_path`, `read_digital_twin`, `write_digital_twin` |

### Когда использовать

| Ситуация | Инструмент |
|----------|-----------|
| Доменный вопрос, паттерн, архитектура | `knowledge-mcp search("запрос", source_type="pack")` |
| Конкретный документ по коду (DP.AGENT.001) | `knowledge-mcp get_document("filename")` |
| Обучение, методология, руководства | `knowledge-mcp search("запрос", source_type="guides")` |
| Цели ученика, самооценка, контекст | `ddt read_digital_twin("1_declarative/1_2_goals")` |
| Структура метамодели двойника | `ddt describe_by_path("/")` |

### Правила

1. **Перед ответом на доменный вопрос** → сначала `knowledge-mcp search`. Не полагаться на память — проверять по базе.
2. **Перед записью в Pack** → `knowledge-mcp search` + `get_document` → убедиться: нет дубликата, нет противоречия.
3. **Конфигурация** → `.claude/settings.local.json` (обновляется через `update.sh`).

---

## 6. АрхГейт (ArchGate) — ОБЯЗАТЕЛЬНАЯ оценка

> **БЛОКИРУЮЩЕЕ.** Архитектурное решение → таблица ЭМОГССБ → вывод. Порог ≥8. Слабые (≤7) — НЕ предлагать.

| Характеристика | Вопрос |
|----------------|--------|
| Эволюционируемость | Что сломается при изменении? |
| Масштабируемость | Что будет при 10x? |
| Обучаемость | Сколько читать, чтобы начать? |
| Генеративность | Создаёт платформу? Работает в шаблоне экзокортекса? |
| Скорость | Бот <3 сек, CLI <1 сек? |
| Современность | Проверь `memory/sota-reference.md` |
| Безопасность | Какие угрозы? PII, секреты, injection surface? |

**Чеклист современности** (приоритетная тройка):
1. Context Engineering (SOTA.002): Write/Select/Compress/Isolate
2. DDD Strategic (SOTA.001): BC, UL, Context Map
3. Coupling Model (SOTA.011): knowledge, distance, volatility

---

## 7. Обновление этого файла

- Новые протоколы → `memory/protocol-*.md`, НЕ сюда
- Различение (1-3 строки) → сюда
- Архитектура репозиториев → сюда
- Стабильные знания → `memory/*.md`

---

*Последнее обновление: 2026-02-26*
