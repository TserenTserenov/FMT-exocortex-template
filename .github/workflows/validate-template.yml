name: Validate Template

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1. Нет автор-специфичного контента
      - name: Check for author-specific content
        run: |
          FAIL=0
          for pattern in "tserentserenov" "PACK-MIM" "aist_bot_newarchitecture" "DS-Knowledge-Index-Tseren"; do
            count=$(grep -rn "$pattern" . --include="*.md" --include="*.sh" \
                    --include="*.json" --include="*.plist" --include="*.yaml" 2>/dev/null | wc -l)
            if [ "$count" -gt 0 ]; then
              echo "FAIL: Found '$pattern' in $count locations:"
              grep -rn "$pattern" . --include="*.md" --include="*.sh" \
                  --include="*.json" --include="*.plist" 2>/dev/null | head -5
              FAIL=1
            fi
          done
          [ "$FAIL" -eq 0 ] && echo "PASS: No author-specific content"
          exit $FAIL

      # 2. Нет захардкоженных /Users/ путей
      - name: Check for hardcoded paths
        run: |
          FAIL=0
          count=$(grep -rn '/Users/' . --include="*.md" --include="*.sh" \
                  --include="*.json" --include="*.plist" 2>/dev/null | wc -l)
          if [ "$count" -gt 0 ]; then
            echo "FAIL: Found /Users/ in $count locations:"
            grep -rn '/Users/' . --include="*.md" --include="*.sh" 2>/dev/null | head -5
            FAIL=1
          fi

          count=$(grep -rn '/opt/homebrew' . --include="*.md" --include="*.sh" \
                  --include="*.json" --include="*.plist" 2>/dev/null \
                  | grep -v 'README.md' \
                  | grep -v 'validate-template.yml' \
                  | grep -v '/usr/local/bin.*:/opt/homebrew' \
                  | wc -l)
          if [ "$count" -gt 0 ]; then
            echo "FAIL: Found /opt/homebrew in $count locations:"
            grep -rn '/opt/homebrew' . --include="*.md" --include="*.sh" 2>/dev/null \
                | grep -v 'README.md' | grep -v 'validate-template.yml' | head -5
            FAIL=1
          fi

          [ "$FAIL" -eq 0 ] && echo "PASS: No hardcoded paths"
          exit $FAIL

      # 3. MEMORY.md — скелет
      - name: Check MEMORY.md is skeleton
        run: |
          if [ -f "memory/MEMORY.md" ]; then
            rows=$(grep -c '^|' memory/MEMORY.md 2>/dev/null || echo 0)
            if [ "$rows" -gt 15 ]; then
              echo "FAIL: MEMORY.md has $rows table rows (expected ≤15)"
              exit 1
            fi
            echo "PASS: MEMORY.md is skeleton ($rows rows)"
          else
            echo "WARN: memory/MEMORY.md not found"
          fi

      # 4. Обязательные файлы
      - name: Check required files
        run: |
          FAIL=0
          for f in CLAUDE.md ONTOLOGY.md README.md \
                   memory/MEMORY.md memory/hard-distinctions.md \
                   roles/strategist/scripts/strategist.sh; do
            if [ ! -f "$f" ]; then
              echo "MISSING: $f"
              FAIL=1
            fi
          done
          [ "$FAIL" -eq 0 ] && echo "PASS: All required files present"
          exit $FAIL

      # 5. MCP-конфигурация
      - name: Check MCP configuration
        run: |
          FAIL=0
          SETTINGS=".claude/settings.local.json"
          if [ ! -f "$SETTINGS" ]; then
            echo "FAIL: $SETTINGS not found"
            exit 1
          fi

          # Check mcpServers section exists
          if ! python3 -c "import json; d=json.load(open('$SETTINGS')); assert 'mcpServers' in d" 2>/dev/null; then
            echo "FAIL: mcpServers section missing in $SETTINGS"
            FAIL=1
          fi

          # Check all 2 MCP servers are configured
          for server in knowledge-mcp ddt; do
            if ! python3 -c "import json; d=json.load(open('$SETTINGS')); assert '$server' in d['mcpServers']" 2>/dev/null; then
              echo "FAIL: MCP server '$server' missing"
              FAIL=1
            fi
          done

          # Check URLs point to aisystant.workers.dev
          BAD_URLS=$(python3 << 'PYEOF'
          import json
          d = json.load(open(".claude/settings.local.json"))
          for name, cfg in d.get("mcpServers", {}).items():
              url = cfg.get("url", "")
              if "aisystant.workers.dev" not in url:
                  print(name + ": " + url)
          PYEOF
          ) || true
          if [ -n "$BAD_URLS" ]; then
            echo "FAIL: MCP URLs not pointing to aisystant.workers.dev:"
            echo "$BAD_URLS"
            FAIL=1
          fi

          [ "$FAIL" -eq 0 ] && echo "PASS: MCP configuration valid (2 servers, correct URLs)"
          exit $FAIL

      # 6. Только допустимые placeholders
      - name: Check placeholders are valid
        run: |
          # Найти все {{...}} и проверить что они из допустимого списка
          ALLOWED="HOME_DIR|WORKSPACE_DIR|GITHUB_USER|CLAUDE_PATH|CLAUDE_PROJECT_SLUG|TIMEZONE_HOUR|TIMEZONE_DESC"
          INVALID=$(grep -rohP '\{\{[A-Z_]+\}\}' . --include="*.md" --include="*.sh" \
                    --include="*.json" --include="*.plist" 2>/dev/null \
                    | sort -u \
                    | grep -vP "\{\{($ALLOWED)\}\}" || true)
          if [ -n "$INVALID" ]; then
            echo "WARN: Unknown placeholders found:"
            echo "$INVALID"
            echo "(This is a warning, not a failure — new placeholders may be intentional)"
          else
            echo "PASS: All placeholders are valid"
          fi
